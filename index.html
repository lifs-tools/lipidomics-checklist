<!DOCTYPE html>
<html>
<head>
<script language="javascript">
var lipidomics_forms_content = [{"name": "Overall study design",
  "content": [
    {"title": "Title of the Study",
     "name": "study-title",
     "type": "text",
     "required": 1,
     "value": "",
     "description": "To whom correspondence should be addressed?"
     },
    {"name": "workflow-type",
     "type": "hidden",
     "value": "di"
     },
    {"title": "Select your weapons",
     "name": "whatever",
     "type": "multiple",
     "required": 1,
     "choice": [
        {"name": "12345",
         "title": "This is the first item",
         "value": 1
         },
        {"name": "321",
         "title": "This is the second item",
         "value": 0
         },
        {"name": "32145",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "321458",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "321457",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "321456",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "321455",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "321454",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "321453",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "321452",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "321451",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "3214521",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "3214512",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "3214522",
         "title": "This is the third item",
         "value": 1
         },
        {"name": "3214511",
         "title": "This is the third item",
         "value": 1
         }
     ],
     "description": "To whom correspondence should be addressed?"
     },
    {"title": "All for combo",
     "name": "mlp",
     "type": "select",
     "choice": [
        {"name": "mrait",
         "title": "This is the first item",
         "value": 0
         },
        {"name": "atl34",
         "title": "This is the second item",
         "value": 1
         },
        {"name": "upga",
         "title": "This is the third item",
         "value": 0
         }
     ],
     "description": "To whom correspondence should be addressed?",
     "condition": "32145=1"
     },
     {"title": "Title of the Study",
     "name": "study-title2",
     "type": "text",
     "required": 0,
     "value": "Foo",
     "description": "To whom correspondence should be addressed?"
     }
     
  ]
},{"name": "Internal standards",
  "content": [
    {"title": "The internal standards",
     "name": "allright",
     "type": "text",
     "required": 1,
     "value": "What are you talking about",
     "description": "To whom correspondence should be addressed?"
     },
    {"title": "Temparature",
     "name": "temp",
     "type": "number",
     "min": 1,
     "max": 20,
     "value": 5,
     "step": 1,
     "description": "What is your favorite temparature?",
     "condition": "workflow-type='di'"
     }
  ]
}
];
var field_map = {};
var dom_field_map = {};
var field_conditions = {};
var field_visible = {};
var form_pages = [];
var dom_form_pages = [];
var current_page = 0;
var required_messages = {};
var dom_text_fields = {};
var form_enabled = true;


function load_data(){
    field_map = {};
    dom_field_map = {};
    field_conditions = {};
    field_visible = {};
    form_pages = [];
    dom_form_pages = [];
    current_page = 0;
    required_messages = {};
    dom_text_fields = {};
    form_enabled = true;
    
    check_fields = {};
    for (page of lipidomics_forms_content){
        for (field of page["content"]){
            // add field info into field map
            if (!("type" in field) || !("name" in field)) continue;
            var field_name = field["name"];
            
            if (field_name in field_map){
                alert("Field with name \"" + field_name + "\" appears to be twice.");
                form_enabled = false;
            }
            field_map[field_name] = field;
            if ((field["type"] == "select" || field["type"] == "multiple") && ("choice" in field)){
                for (choice of field["choice"]){
                    if ("name" in choice){
                        var choice_name = choice["name"];
                        if (choice_name in field_map){
                            alert("Choice with name \"" + choice_name + "\" appears to be twice.");
                            form_enabled = false;
                        }
                        field_map[choice["name"]] = choice;
                    }
                }
            }
            
            // check for any logical conditions
            if (!("condition" in field) || field["condition"].length == 0) continue;
            
            check_fields[field_name] = [];
            var condition = [];
            for (condition_and of field["condition"].split("|")){
                var conjunction = [];
                for (con of condition_and.split("&")){
                    var single_condition = con.split("=");
                    if (single_condition.length != 2){
                        alert("Corrupted condition \"" + field["condition"] + "\" in field \"" + field_name + "\".");
                        form_enabled = false;
                        continue;
                    }
                    
                    var l = single_condition[1].length;
                    
                    if (single_condition[1][0] === "'" && single_condition[1][l - 1] === "'"){
                        single_condition[1] = single_condition[1].substring(1, l - 1);
                    }
                    else {
                        // check if value is a number
                        single_condition[1] = parseFloat(single_condition[1]);
                        if (isNaN(single_condition[1])){
                            alert("Corrupted condition \"" + field["condition"] + "\" in field \"" + field_name + "\".");
                            form_enabled = false;
                            continue;
                        }
                    }
                    check_fields[field_name].push(single_condition[0]);
                    conjunction.push(single_condition);
                }
                condition.push(conjunction);
            }
            field_conditions[field["name"]] = condition;
        }
    }
    // check if all required fields are actually present
    for (field_name in check_fields){
        if (!form_enabled) break;
        for (required_field of check_fields[field_name]){
            if (!(required_field in field_map)){
                alert("Error: required field \"" + required_field + "\" by field \"" + field_name + "\" is not in form.");
                form_enabled = false;
                break;
            }
        }
    }
    

    for (field_name in field_map){
        field_visible[field_name] = true;
    }
    
    var form_viewer = document.getElementById("form-viewer");
    var page_cnt = 0;
    for (page of lipidomics_forms_content){
        var obj_page = document.createElement("div");
        obj_page.className = "lipidomics-forms-page";
        dom_form_pages.push(obj_page);
        
        var forms_in_page = [];
        form_pages.push(forms_in_page);
        
        
        // Status decorator
        if (lipidomics_forms_content.length > 1){
            var obj_status = document.createElement("div");
            obj_status.className = "lipidomics-forms-status";
            obj_page.append(obj_status);
            
            var obj_status_text = document.createElement("div");
            obj_status_text.className = "lipidomics-forms-status-text";
            obj_status_text.innerHTML = "<font size='+1'>" + (("name" in page) ? page["name"] : "X") + " - Page " + (page_cnt + 1) + " of " + lipidomics_forms_content.length + "</font>";
            obj_status.append(obj_status_text);
            
            var obj_status_bar = document.createElement("div");
            obj_status_bar.className = "lipidomics-forms-status-bar";
            obj_status.append(obj_status_bar);
            
            var obj_status_bar_progress = document.createElement("div");
            obj_status_bar_progress.className = "lipidomics-forms-status-bar-progress";
            obj_status_bar_progress.style.width = ((page_cnt + 1) / lipidomics_forms_content.length * 100) + "%";
            obj_status_bar.append(obj_status_bar_progress);
        }
        
        
        for (field of page["content"]){
            if (!("type" in field) || !("name" in field)) continue;
            var field_name = field["name"];

            var obj = document.createElement("div");
            obj.className = "lipidomics-forms-field";
            dom_field_map[field_name] = obj;
            obj_page.append(obj);
            forms_in_page.push(field_name);
            
            if (field["type"] == "text"){
                if (!("title" in field)) continue;
                if (!("value" in field)) field["value"] = "";
                if (!("description" in field)) field["description"] = "";
                
                // Adding the title of the field
                var obj_title = document.createElement("div");
                obj_title.className = "lipidomics-forms-field-title";
                obj_title.innerHTML = "<b>" + field["title"] + "</b>";
                if (("required" in field) && field["required"] == 1){
                    obj_title.innerHTML += " <font color='red'>*</font>";
                }
                obj.append(obj_title);
                
                // Adding the text field of the field
                var obj_content = document.createElement("div");
                obj_content.className = "lipidomics-forms-field-content";
                var obj_input = document.createElement("input");
                obj_input.className = "lipidomics-forms-input";
                obj_input.type = "text";
                obj_input.value = field["value"];
                obj_input.content = field;
                obj_input.field_name = field_name;
                obj_input.setAttribute('onchange','update_text(this);');
                obj_content.append(obj_input);
                obj.append(obj_content);
                dom_text_fields[field_name] = obj_input;
                
                // Adding description of the field if present
                if (field["description"].length > 0){
                    var obj_description = document.createElement("div");
                    obj_description.className = "lipidomics-forms-field-description";
                    obj_description.innerHTML = field["description"];
                    obj.append(obj_description);
                }
                
                var obj_required = document.createElement("div");
                obj_required.className = "lipidomics-forms-required-message";
                obj_required.innerHTML = "This field is required.";
                obj_required.style.display = "none";
                obj.append(obj_required);
                required_messages[field_name] = obj_required;
            }
            
            if (field["type"] == "number"){
                if (!("title" in field)) continue;
                if (!("value" in field)) field["value"] = "";
                if (!("description" in field)) field["description"] = "";
                
                // Adding the title of the field
                var obj_title = document.createElement("div");
                obj_title.className = "lipidomics-forms-field-title";
                obj_title.innerHTML = "<b>" + field["title"] + "</b>";
                if (("required" in field) && field["required"] == 1){
                    obj_title.innerHTML += " <font color='red'>*</font>";
                }
                obj.append(obj_title);
                
                // Adding the text field of the field
                var obj_content = document.createElement("div");
                obj_content.className = "lipidomics-forms-field-content";
                var obj_input = document.createElement("input");
                obj_input.className = "lipidomics-forms-number";
                obj_input.type = "number";
                obj_input.value = field["value"];
                if ("min" in field) obj_input.min = field["min"];
                if ("max" in field) obj_input.min = field["max"];
                if ("step" in field) obj_input.min = field["step"];
                obj_input.content = field;
                obj_input.field_name = field_name;
                obj_input.setAttribute('onchange','update_text(this);');
                obj_content.append(obj_input);
                obj.append(obj_content);
                dom_text_fields[field_name] = obj_input;
                
                // Adding description of the field if present
                if (field["description"].length > 0){
                    var obj_description = document.createElement("div");
                    obj_description.className = "lipidomics-forms-field-description";
                    obj_description.innerHTML = field["description"];
                    obj.append(obj_description);
                }
                
                var obj_required = document.createElement("div");
                obj_required.className = "lipidomics-forms-required-message";
                obj_required.innerHTML = "This field is required.";
                obj_required.style.display = "none";
                obj.append(obj_required);
                required_messages[field_name] = obj_required;
            }
            
            else if (field["type"] == "multiple"){
                if (!("title" in field) || !("choice" in field)) continue;
                if (!("description" in field)) field["description"] = "";
                
                
                // Adding the title of the field
                var obj_title = document.createElement("div");
                obj_title.className = "lipidomics-forms-field-title";
                obj_title.innerHTML = "<b>" + field["title"] + "</b>";
                if (("required" in field) && field["required"] == 1){
                    obj_title.innerHTML += " <font color='red'>*</font>";
                }
                obj.append(obj_title);
                
                // Adding the checkbox fields of the field
                var obj_content = document.createElement("div");
                obj_content.className = "lipidomics-forms-field-content";
                var obj_ul = document.createElement("ul");
                obj_ul.className = "lipidomics-forms-multiple";
                for (choice of field["choice"]){
                    if (!("name" in choice)) continue;
                    if (!("title" in choice)) choice["title"] = "Null";
                    if (!("value" in choice)) choice["value"] = 0;
                    
                    var obj_li = document.createElement("ul");
                    obj_ul.append(obj_li);
                    obj_li.className = "lipidomics-forms-li";
                    
                    var obj_input = document.createElement("input");
                    obj_li.append(obj_input);
                    
                    obj_input.type = "checkbox";
                    obj_input.content = choice;
                    obj_input.field_name = field_name;
                    if (choice["value"] == 1) obj_input.checked = true;
                    obj_input.setAttribute('onchange','update_choice(this);');
                    
                    var obj_label = document.createElement("label");
                    obj_li.append(obj_label);
                    obj_label.innerHTML = choice["title"];
                    
                }
                obj_content.append(obj_ul);
                obj.append(obj_content);
                
                // Adding description of the field if present
                if (field["description"].length > 0){
                    var obj_description = document.createElement("div");
                    obj_description.className = "lipidomics-forms-field-description";
                    obj_description.innerHTML = field["description"];
                    obj.append(obj_description);
                }
                
                var obj_required = document.createElement("div");
                obj_required.className = "lipidomics-forms-required-message";
                obj_required.innerHTML = "This field is required.";
                obj_required.style.display = "none";
                obj.append(obj_required);
                required_messages[field_name] = obj_required;
            }
            
            else if (field["type"] == "select"){
                if (!("title" in field) || !("choice" in field)) continue;
                if (!("description" in field)) field["description"] = "";
                
                
                // Adding the title of the field
                var obj_title = document.createElement("div");
                obj_title.className = "lipidomics-forms-field-title";
                obj_title.innerHTML = "<b>" + field["title"] + "</b>";
                if (("required" in field) && field["required"] == 1){
                    obj_title.innerHTML += " <font color='red'>*</font>";
                }
                obj.append(obj_title);
                
                // Adding the checkbox fields of the field
                var obj_content = document.createElement("div");
                obj_content.className = "lipidomics-forms-field-content";
                var obj_select = document.createElement("select");
                obj_select.className = "lipidomics-forms-select";
                obj_select.content = field;
                obj_select.field_name = field_name;
                var selectedIndex = 0;
                var cnt = 0;
                for (choice of field["choice"]){
                    if (!("name" in choice)) continue;
                    if (!("title" in choice)) choice["title"] = "Null";
                    if (!("value" in choice)) choice["value"] = 0;
                    
                    var obj_option = document.createElement("option");
                    obj_select.append(obj_option);
                    if (choice["value"] == 1) selectedIndex = cnt;
                    
                    obj_option.innerHTML = choice["title"];
                    cnt++;
                }
                obj_select.selectedIndex = selectedIndex;
                obj_select.setAttribute('onchange','update_select(this);');
                obj_content.append(obj_select);
                obj.append(obj_content);
                
                
                // Adding description of the field if present
                if (field["description"].length > 0){
                    var obj_description = document.createElement("div");
                    obj_description.className = "lipidomics-forms-field-description";
                    obj_description.innerHTML = field["description"];
                    obj.append(obj_description);
                }
                
                var obj_required = document.createElement("div");
                obj_required.className = "lipidomics-forms-required-message";
                obj_required.innerHTML = "This field is required.";
                obj_required.style.display = "none";
                obj.append(obj_required);
                required_messages[field_name] = obj_required;
            }
        }
        obj_page.style.display = (page_cnt == 0) ? "block" : "none";
            
        if (page_cnt > 0){ 
            var obj_prev = document.createElement("button");
            obj_prev.className = "submit-button";
            obj_prev.disabled = !form_enabled;
            obj_prev.innerHTML = "Previous & Save";
            obj_prev.setAttribute('onclick','change_page(-1);');
            obj_page.append(obj_prev);
        }
            
        var obj_next = document.createElement("button");
        obj_next.className = "submit-button";
        obj_next.disabled = !form_enabled;
        if (page_cnt < lipidomics_forms_content.length - 1){
            obj_next.innerHTML = "Next & Save";
            obj_next.setAttribute('onclick','change_page(1);');
        }
        else {
            obj_next.innerHTML = "Submit";
            obj_next.setAttribute('onclick','submit_form();');
        }
        obj_page.append(obj_next);
        
        form_viewer.append(obj_page);
        
        page_cnt++;
    }
    check_conditions();
    change_page(0);
}





function update_text(form){
    if (!form_enabled) return;
    
    var field_name = form.content["name"];
    form.content["value"] = form.value;
    required_messages[field_name].style.display = "none";
    form.style.border = "1px solid #ccc";
    check_conditions();
}



function update_choice(form){
    if (!form_enabled) return;
    
    var field_name = form.field_name;
    form.content["value"] = form.checked ? 1 : 0;
    required_messages[field_name].style.display = "none";
    check_conditions();
}



function update_select(form){
    if (!form_enabled) return;
    
    var field_name = form.content["name"];
    var l = form.content["choice"].length;
    for (var i = 0; i < l; ++i){
        form.content["choice"][i]["value"] = (i == form.selectedIndex) ? 1 : 0;
    }
    required_messages[field_name].style.display = "none";
    check_conditions();
}


function check_conditions(){
    if (!form_enabled) return;

    for (field_name in field_conditions){
        field_visible[field_name] = false;
        for (condition_and of field_conditions[field_name]){
            var condition_met = true;
            for (single_condition of condition_and){
                var key = single_condition[0];
                var value = single_condition[1];
                condition_met &= field_map[key]["value"] == value;
            }
            field_visible[field_name] |= condition_met;
        }
        dom_field_map[field_name].style.display = field_visible[field_name] ? "block" : "none";
    }
}


function check_requirements(){
    if (!form_enabled) return false;
    
    var first_required = null;
    for (form_name of form_pages[current_page]){
        if (!("required" in field_map[form_name]) || field_map[form_name]["required"] == 0) continue;
        
        if (field_map[form_name]["type"] == "text"){
            if (field_map[form_name]["value"].length > 0) continue;
            
            dom_text_fields[form_name].style.border = "1px solid #cc0000";
        }
        else if (field_map[form_name]["type"] == "multiple"){
            var something_selected = false;
            for (choice of field_map[form_name]["choice"]){
                something_selected |= choice["value"] != 0;
            }
            if (something_selected) continue;
        }
        
        
        if (first_required == null) first_required = form_name;
        required_messages[form_name].style.display = "block";
    }
    
    // move to first required
    if (first_required != null){
        dom_field_map[first_required].scrollIntoView();
    }

    return first_required == null;
}


function change_page(offset){
    if (offset != 0 && !check_requirements()) return;

    current_page = Math.min(Math.max(current_page + offset, 0), lipidomics_forms_content.length - 1);
    var i = 0;
    for (page of dom_form_pages){
        page.style.display = (current_page == i++) ? "block" : "none";
    }
}

function submit_form(){
    if (!form_enabled) return;
    if (!check_requirements()) return;
}



</script>
<style>
.lipidomics-forms-page {
}

.lipidomics-forms-field {
    margin: 0 0 25px 0;
    width: 100%;
}

.lipidomics-forms-field-title {
    margin: 1px 0 1px 0;
}

.lipidomics-forms-field-content {
}

.lipidomics-forms-required-message {
    color: #990000;
}

.lipidomics-forms-input {
    padding: 6px 10px;
    max-width: 60%;
    border: 1px solid #ccc;
    border-radius: 2px;
    width: 100%;
}

.lipidomics-forms-number {
    padding: 6px 10px;
    max-width: 60%;
    border: 1px solid #ccc;
    border-radius: 2px;
    width: 100%;
}

.lipidomics-forms-li {
    padding: 6px 10px;
    max-width: 60%;
    width: 100%;
}

.lipidomics-forms-select {
    padding: 6px 10px;
    max-width: 60%;
    border: 1px solid #ccc;
    border-radius: 2px;
    width: 100%;
    text-transform: none;
    white-space: nowrap;
    background-color: #fff;
}

.lipidomics-forms-multiple {
    list-style: none;
    padding-left: 0;
    margin: 0px 0 0px 0;
}

.lipidomics-forms-field-description {
    font-size: 13px;
    margin: 1px 0 1px 0;
}

.submit-button {
    background-color: #ddd;
    border: 1px solid #ccc;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: 400;
    margin: 0 5px;
    min-width: 90px;
    text-align: center;
    padding: 10px 15px;
}

.submit-button:hover {
    background-color: #eee;
}

.submit-button:active {
    background-color: #ccc;
}

.lipidomics-forms-status {
    margin: 0 0 30px 0;
}

.lipidomics-forms-status-bar {
    background-color: #ddd;
    height: 18px;
    border-radius: 10px;
    overflow: hidden;
    width: 100%;
    margin: 5px 0 0;
    padding: 0 0 0 0;
}

.lipidomics-forms-status-bar-progress {
    background-color: #009900;
    height: 18px;
    border-radius-left: 10px;
    overflow: hidden;
    position: relative;
    left: 0;
    top: 0;
}

</style>
</head>


<body>

<div id="form-viewer">
</div>


</body>
<script language="javascript">
load_data();
</script>
</html>
